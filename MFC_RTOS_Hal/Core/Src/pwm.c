/**
  ******************************************************************************
  * @file    pwm.c
  * @author  deadnight
  * @version V1.0
  * @date    2018-01-02
  * @brief   pwm
  ******************************************************************************
  * @attention
  ******************************************************************************
  */ 	
#include "pwm.h"
 

#define DitherBit   32
uint8_t aDitherTable[32][32]={{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1},{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1},{0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1},{0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1},{0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1},{0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1},{0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1},{0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1},{0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,1},{0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,1},{0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,0,1,0,1,0,1,0,1,0,1},{0,0,0,1,0,0,0,1,0,1,0,1,0,1,0,1,0,0,0,1,0,0,0,1,0,1,0,1,0,1,0,1},{0,0,0,1,0,0,0,1,0,1,0,1,0,1,0,1,0,0,0,1,0,1,0,1,0,1,0,1,0,1,0,1},{0,0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,0,0,1,0,1,0,1,0,1,0,1,0,1,0,1},{0,0,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1},{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1},{0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1,1},{0,1,0,1,0,1,0,1,0,1,0,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1,1},{0,1,0,1,0,1,0,1,0,1,0,1,0,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,1,1,1,1},{0,1,0,1,0,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,1,1,1,1},{0,1,0,1,0,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,0,1,0,1,1,1,1,1,1,1},{0,1,0,1,0,1,0,1,0,1,1,1,1,1,1,1,0,1,0,1,0,1,0,1,0,1,1,1,1,1,1,1},{0,1,0,1,0,1,0,1,0,1,1,1,1,1,1,1,0,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1},{0,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1},{0,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1},{0,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1},{0,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1},{0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1},{0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},{0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}}; 
//uint8_t aDitherTable[8][8] = {{0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,1},{0,0,0,1,0,0,0,1},{0,0,0,1,0,1,0,1},{0,1,0,1,0,1,0,1},{0,1,0,1,1,0,1,1},{0,1,1,1,0,1,1,1},{0,1,1,1,1,1,1,1}};

uint32_t vDitherTemp[DitherBit];
uint32_t vDither[DitherBit*2];
uint8_t BufferSize = DitherBit*2;

uint16_t duty_Cycle ;//取整
uint8_t Dither_Index;//余数
uint8_t PWM_Value_FirstPart_Changed=0;
uint8_t PWM_Value_SecondPart_Changed=0;

 
/**************** 计算PWM重装值函数 *******************/
//注意：TIM_SetCompare4的4为ch4的寄存器（PA3）-TIM2 CH4
void    LoadPWM(uint32_t pwmval)
{	
	uint8_t i;
 
	#ifdef __PWM_DITHER_MODE_
	duty_Cycle = (uint16_t)(pwmval/DitherBit);//取整
	Dither_Index = (uint16_t)(pwmval%DitherBit) ;//余数
	for(i = 0;i<DitherBit;i++){		
		vDitherTemp[i] =  (uint16_t)(duty_Cycle+aDitherTable[Dither_Index][i]);
	}
	PWM_Value_FirstPart_Changed =0;
	PWM_Value_SecondPart_Changed =0;
	#endif
	
	#ifdef __PWM_NONMAL_MODE_
	TIM_SetCompare2(TIM2,pwmval);	
	#endif
}
void DMA_Half_Transfer_interrupt(void){
	uint8_t i= 0;
	for(i = 0;i<DitherBit;i++){
		vDither[i] = vDitherTemp[i];
	}
	PWM_Value_FirstPart_Changed = 1;
}
void DMA_Total_Transfer_interrupt(void){
	uint8_t i= 0;
	for(i = 0;i<DitherBit;i++){
		vDither[i+DitherBit] = vDitherTemp[i];
	}
	PWM_Value_SecondPart_Changed =1;
}
 
void PWM_DMA1_Channel7_IRQHandler(void)
{	
	/*if(__HAL_TIM_GET_FLAG(DMA1_IT_TC7) !=RESET){
		DMA_ClearITPendingBit( DMA1_IT_TC7 );
		if(PWM_Value_SecondPart_Changed ==0)
			DMA_Total_Transfer_interrupt();
	}
	if(DMA_GetITStatus(DMA1_IT_HT7) !=RESET)
	{
		DMA_ClearITPendingBit( DMA1_IT_HT7 );
		if(PWM_Value_FirstPart_Changed ==0)
			DMA_Half_Transfer_interrupt();		
	}
	if(DMA_GetITStatus(DMA1_IT_TE7) !=RESET)	
	{
		DMA_ClearITPendingBit( DMA1_IT_TE7 );
	}*/
  
}
/*********************************************END OF FILE**********************/
